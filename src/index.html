<html><head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Bootstrap demo</title>
    <link href="https://startbootstrap.github.io/startbootstrap-sb-admin-2/css/sb-admin-2.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="https://startbootstrap.github.io/startbootstrap-sb-admin-2/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style type="text/css">/* Chart.js */
    @keyframes chartjs-render-animation{from{opacity:.99}to{opacity:1}}.chartjs-render-monitor{animation:chartjs-render-animation 1ms}.chartjs-size-monitor,.chartjs-size-monitor-expand,.chartjs-size-monitor-shrink{position:absolute;direction:ltr;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1}.chartjs-size-monitor-expand>div{position:absolute;width:1000000px;height:1000000px;left:0;top:0}.chartjs-size-monitor-shrink>div{position:absolute;width:200%;height:200%;left:0;top:0}
    </style>
<style type="text/css">/* Chart.js */
@keyframes chartjs-render-animation{from{opacity:.99}to{opacity:1}}.chartjs-render-monitor{animation:chartjs-render-animation 1ms}.chartjs-size-monitor,.chartjs-size-monitor-expand,.chartjs-size-monitor-shrink{position:absolute;direction:ltr;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1}.chartjs-size-monitor-expand>div{position:absolute;width:1000000px;height:1000000px;left:0;top:0}.chartjs-size-monitor-shrink>div{position:absolute;width:200%;height:200%;left:0;top:0}</style></head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <div id="wrapper">

    <!-- Sidebar -->

    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">

            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">


                        <ul class="navbar-nav">

                            <li class="nav-item mb-2 pl-1 py-3">
                                <button class="btn" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Shelf label printing
                                </button>
                                <!-- Dropdown - Messages -->

                            </li>

                        <li class="nav-item mb-2 pl-1 py-3">
                                <button class="btn btn-primary" onclick="closeSession()" id="closeSession" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Close Session
                                </button>
                                <!-- Dropdown - Messages -->

                            </li></ul>

                    </nav>
            <!-- End of Topbar -->

            <!-- Begin Page Content -->
            <div class="container-fluid">

                <!-- Page Heading -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <p id="sessionId" class="h5 mb-0 text-gray-800">Session: 399009</p>

                </div>

                <!-- Content Row -->
                <div class="row mb-4">
                <div class="col-6">
                                <div class="card bg-primary text-white shadow">
                                    <div class="card-body"># Scanned Items
                                    <div id="numItems" class="text-white-50 small">0</div>
                                    </div>
                                </div>
                            </div><div class="col-6">
                                <div id="lastItemContainer" class="card bg-success text-white shadow">
                                    <div class="card-body">Last scanned item
                                      <div id="lastItem" class="text-white-50 small">...</div>
                                    </div>
                                </div>
                            </div></div>
                <div class="row">

                    <!-- Content Column -->
                    <div class="col-lg-6 mb-4">

                        <!-- Project Card Example -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Scanning AREA</h6>
                            </div>
                            <div class="card-body">
                              <div id="reader" style="height:100%; width:100%;">

                              </div>
                            </div>
                        </div>

                        <!-- Color System -->
                        <div id="barcodeList" class="row">
                          <!--
                            <div class="col-lg-6 mb-1">
                                <div class="card bg-primary text-white shadow">
                                    <div class="card-body">
                                        Primary
                                        <div class="text-white-50 small">#4e73df</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-success text-white shadow">
                                    <div class="card-body">
                                        Success
                                        <div class="text-white-50 small">#1cc88a</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-info text-white shadow">
                                    <div class="card-body">
                                        Info
                                        <div class="text-white-50 small">#36b9cc</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-warning text-white shadow">
                                    <div class="card-body">
                                        Warning
                                        <div class="text-white-50 small">#f6c23e</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-danger text-white shadow">
                                    <div class="card-body">
                                        Danger
                                        <div class="text-white-50 small">#e74a3b</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-secondary text-white shadow">
                                    <div class="card-body">
                                        Secondary
                                        <div class="text-white-50 small">#858796</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-light text-black shadow">
                                    <div class="card-body">
                                        Light
                                        <div class="text-black-50 small">#f8f9fc</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-dark text-white shadow">
                                    <div class="card-body">
                                        Dark
                                        <div class="text-white-50 small">#5a5c69</div>
                                    </div>
                                </div>
                            </div>
                            -->
                        </div>

                    </div>


                </div>

            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- End of Main Content -->

        <!-- Footer -->

        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>

  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/vendor/jquery/jquery.min.js"></script>
  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/js/sb-admin-2.min.js"></script>
  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/vendor/chart.js/Chart.min.js"></script>
  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/js/demo/chart-area-demo.js"></script>
  <script src="https://startbootstrap.github.io/startbootstrap-sb-admin-2/js/demo/chart-pie-demo.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>

  <script>

    var barcodes = [];
    var numItems = 0;
    var lastItem = "";

    const queryString     = window.location.search;
    const urlParams       = new URLSearchParams(queryString);
    const sessionId       = urlParams.get('sessionId');
    const sessionIdString = "Session:" + sessionId;

    var sessionElem       = document.getElementById("sessionId");
    sessionElem.innerText = sessionIdString;


    const connection = new signalR.HubConnectionBuilder()
        .withUrl("https://azfmaftest.azurewebsites.net/api")
        .withAutomaticReconnect()
        .configureLogging(signalR.LogLevel.Information)
        .build();

    connection.on('newMessage', (message) => {
        console.log(message);
    });

    connection.start().catch(console.error);

    function closeSession()
    {
      $.ajax({
                    type: "POST",
                    url: "https://azfmaftest.azurewebsites.net/api/sendMessage",
               dataType: "json",
            contentType: "application/json; charset=utf-8",
                   data: '{"SessionId":"' + sessionId + '"}',
                success: function (respData, status, xhr) {
                alert("Session closed!")
              },
              error: function (xhr, status, error) {

              }
            })

    }

    function onScanSuccess(decodedText, decodedResult) {

      if (lastItem != decodedText)
      {
        var idx = barcodes.indexOf(decodedText);
        if (idx == -1)
        {
          numItems = barcodes.length;
          newBarcodeRead(decodedText);
        }

        // handle the scanned code as you like, for example:
        lastItem = decodedText;
        updateUI();
        console.log(`Code matched = ${decodedText}`, decodedResult);
      }
    }

    function updateUI()
    {
      var elemNumItems = document.getElementById("numItems");
      var elemLastItem = document.getElementById("lastItem");
      elemNumItems.innerText = numItems;
      elemLastItem.innerText = lastItem;
    }

    function newBarcodeRead(barcode)
    {
      $.ajax({
                    type: "POST",
                    url: "https://afagentportal-ro-uat.azurewebsites.net/api/AddShelfLabelToSession",
               dataType: "json",
            contentType: "application/json; charset=utf-8",
                   data: '{"User":"barcodereader", "SessionCode":"' + sessionId +'","ItemBarcode":"'+barcode+ '"}',
                success: function (respData, status, xhr) {
                  var elemContainer = document.getElementById("lastItemContainer");
                  elemContainer.className = "";

                  if (respData.length == 0) {

                    elemContainer.className = "card bg-danger text-white shadow";
                    var barcodeList = document.getElementById("barcodeList");
                    var listElement = document.createElement("div");
                    listElement.className = "col-lg-6 mb-2";
                    listElement.innerHTML = `<div class="card bg-danger text-white shadow">
                                             <div class="card-body">
                                              ${barcode}
                                            <div class="text-white-50 small">Not found</div>
                                            </div>
                                            </div>`;
                    barcodeList.appendChild(listElement);

                  } else {
                    elemContainer.className = "card bg-success text-white shadow";
                    barcodes.push(barcode);
                    var barcodeList = document.getElementById("barcodeList");
                    var listElement = document.createElement("div");
                    listElement.className = "col-lg-6 mb-2";
                    listElement.innerHTML = `<div class="card bg-success text-white shadow">
                                             <div class="card-body">
                                              ${barcode}
                                            <div class="text-white-50 small">${respData[0].NAME}</div>
                                            </div>
                                            </div>`;
                    barcodeList.appendChild(listElement);
                  }
              },
              error: function (xhr, status, error) {
                  alert("Result" + ": " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
              }
            })
    }

    // This method will trigger user permissions
    Html5Qrcode.getCameras().then(devices => {
      /**
       * devices would be an array of objects of type:
       * { id: "id", label: "label" }
       */
      if (devices && devices.length) {
        var cameraId = devices[0].id;
        // .. use this to start scanning.
        console.log(cameraId);
      }
    }).catch(err => {
      // handle err
    });

    function onScanFailure(error) {
      // handle scan failure, usually better to ignore and keep scanning.
      // for example:
      console.warn(`Code scan error = ${error}`);
    }
    let html5QrcodeScanner = new Html5QrcodeScanner("reader",{ fps: 10, qrbox: {width: 250, height: 250} },/* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
  </script>
</body>
</html>
